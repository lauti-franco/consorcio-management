// prisma/schema.prisma - VERSIÓN CORREGIDA Y LIMPIA
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones COMPLETAS
  userTenants UserTenant[]
  properties  Property[]
  expenses    Expense[]
  units       Unit[]
  payments    Payment[]
  tickets     Ticket[]
  tasks       Task[]
  files       File[]
  notifications Notification[]
  notificationTemplates NotificationTemplate[]
  calendarEvents CalendarEvent[]
  chatRooms   ChatRoom[]
  documents   Document[]
  
  @@map("tenants")
}

model User {
  id              String    @id @default(cuid())
  name            String
  email           String    @unique
  passwordHash    String
  role            UserRole  @default(RESIDENT)
  phone           String?
  avatar          String?
  isActive        Boolean   @default(true)
  emailVerified   Boolean   @default(false)
  lastLogin       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relaciones de SaaS
  subscription    Subscription?
  ownedProperties Property[]  @relation("PropertyOwner")
  managedUnits    Unit[]      @relation("UnitManager")
  
  // Relaciones multi-tenant
  userTenants     UserTenant[]
  
  // Relaciones existentes
  expenses        Expense[]    @relation("ExpenseUser")
  payments        Payment[]
  tickets         Ticket[]     @relation("TicketReporter")
  assignedTickets Ticket[]     @relation("TicketAssignee")
  assignedTasks   Task[]       @relation("TaskAssignee")
  createdTasks    Task[]       @relation("TaskCreator")
  refreshTokens   RefreshToken[]
  files           File[]
  
  // Nuevas relaciones
  notifications   Notification[]
  createdCalendarEvents CalendarEvent[] @relation("CalendarEventCreator")
  calendarAttendees CalendarAttendee[]
  chatParticipants ChatParticipant[]
  sentMessages    ChatMessage[] @relation("MessageSender")
  readMessages    MessageRead[]
  uploadedDocuments Document[]
  documentPermissions DocumentPermission[]

  @@map("users")
}

model UserTenant {
  id       String   @id @default(cuid())
  userId   String
  tenantId String
  role     UserRole @default(RESIDENT)

  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("user_tenants")
}

model Subscription {
  id                    String   @id @default(cuid())
  plan                  PlanType @default(STARTER)
  status                SubscriptionStatus @default(ACTIVE)
  stripeSubscriptionId  String?
  stripeCustomerId      String?
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean  @default(false)
  
  // Límites del plan
  maxProperties         Int      @default(1)
  maxUsers              Int      @default(10)
  features              Json     @default("{}")
  
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("subscriptions")
}

model Property {
  id        String   @id @default(cuid())
  name      String
  address   String
  city      String
  settings  Json     @default("{}")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación con Tenant
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relaciones mejoradas
  ownerId   String
  owner     User     @relation("PropertyOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  units     Unit[]
  expenses  Expense[]
  tickets   Ticket[]
  tasks     Task[]    @relation("TaskProperty")
  calendarEvents CalendarEvent[]
  chatRooms ChatRoom[]
  documents Document[]

  @@map("properties")
}

model Unit {
  id          String   @id @default(cuid())
  number      String
  floor       Int
  type        UnitType @default(APARTMENT)
  area        Float?
  bedrooms    Int?
  bathrooms   Int?
  isOccupied  Boolean  @default(false)
  features    String[]

  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Relaciones mejoradas
  managerId   String?
  manager     User?    @relation("UnitManager", fields: [managerId], references: [id])
  expenses    Expense[]
  payments    Payment[]
  tickets     Ticket[]

  // Relación con Tenant
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([propertyId, number])
  @@map("units")
}

model Expense {
  id          String        @id @default(cuid())
  concept     String
  amount      Float
  dueDate     DateTime
  period      String?
  type        ExpenseType   @default(ORDINARY)
  status      ExpenseStatus @default(OPEN)
  
  propertyId  String
  property    Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Relaciones mejoradas
  unitId      String?
  unit        Unit?         @relation(fields: [unitId], references: [id])
  userId      String?
  user        User?         @relation("ExpenseUser", fields: [userId], references: [id])
  payments    Payment[]

  // Relación con Tenant
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("expenses")
}

model Payment {
  id          String        @id @default(cuid())
  amount      Float
  date        DateTime      @default(now())
  method      PaymentMethod
  status      PaymentStatus @default(PENDING)
  transactionId String?
  receiptUrl  String?
  
  expenseId   String
  expense     Expense       @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  
  unitId      String
  unit        Unit          @relation(fields: [unitId], references: [id])

  // Relación con Tenant
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Ticket {
  id           String       @id @default(cuid())
  title        String
  description  String
  priority     Priority     @default(MEDIUM)
  status       TicketStatus @default(OPEN)
  category     String
  
  userId       String
  user         User         @relation("TicketReporter", fields: [userId], references: [id])
  
  assignedToId String?
  assignedTo   User?        @relation("TicketAssignee", fields: [assignedToId], references: [id])
  
  propertyId   String
  property     Property     @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  unitId       String?
  unit         Unit?        @relation(fields: [unitId], references: [id])
  
  // Relación con Tenant
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  photos       String[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("tickets")
}

model Task {
  id           String     @id @default(cuid())
  title        String
  description  String
  priority     Priority   @default(MEDIUM)
  status       TaskStatus @default(PENDING)
  dueDate      DateTime?
  
  assignedToId String
  assignedTo   User       @relation("TaskAssignee", fields: [assignedToId], references: [id])
  
  createdById  String
  createdBy    User       @relation("TaskCreator", fields: [createdById], references: [id])
  
  propertyId   String
  property     Property   @relation("TaskProperty", fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Relación con Tenant
  tenantId     String
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  photos       String[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("tasks")
}

model File {
  id         String   @id @default(cuid())
  key        String   @unique
  url        String
  mimeType   String
  size       Int
  uploadedBy String
  user       User     @relation(fields: [uploadedBy], references: [id])
  
  // Relación con Tenant
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@map("files")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@map("refresh_tokens")
}

model Notification {
  id          String         @id @default(cuid())
  type        NotificationType
  title       String
  message     String
  data        Json?          // Datos adicionales
  isRead      Boolean        @default(false)
  priority    Priority       @default(MEDIUM)
  
  // Relaciones
  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId    String
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime       @default(now())
  scheduledAt DateTime?      // Para notificaciones programadas
  sentAt      DateTime?      // Cuando se envió realmente

  @@map("notifications")
}

model NotificationTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  type        NotificationType
  subject     String
  body        String
  variables   String[] // ["{userName}", "{dueDate}", "{amount}"]
  isActive    Boolean  @default(true)
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("notification_templates")
}

model CalendarEvent {
  id          String        @id @default(cuid())
  title       String
  description String?
  type        CalendarEventType
  startDate   DateTime
  endDate     DateTime
  allDay      Boolean       @default(false)
  location    String?
  
  // Relaciones
  propertyId  String?
  property    Property?     @relation(fields: [propertyId], references: [id])
  createdById String
  createdBy   User          @relation("CalendarEventCreator", fields: [createdById], references: [id])
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Participantes
  attendees   CalendarAttendee[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("calendar_events")
}

model CalendarAttendee {
  id       String   @id @default(cuid())
  eventId  String
  event    CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status   AttendeeStatus @default(PENDING)

  @@unique([eventId, userId])
  @@map("calendar_attendees")
}

model ChatRoom {
  id          String   @id @default(cuid())
  name        String?
  type        ChatRoomType @default(DIRECT)
  propertyId  String?
  property    Property? @relation(fields: [propertyId], references: [id])
  
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Relaciones
  participants ChatParticipant[]
  messages     ChatMessage[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("chat_rooms")
}

model ChatParticipant {
  id       String   @id @default(cuid())
  roomId   String
  room     ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt DateTime @default(now())
  isActive Boolean  @default(true)

  @@unique([roomId, userId])
  @@map("chat_participants")
}

model ChatMessage {
  id        String   @id @default(cuid())
  content   String
  type      MessageType @default(TEXT)
  
  roomId    String
  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  senderId  String
  sender    User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  readBy    MessageRead[]
  parentId  String?
  parent    ChatMessage? @relation("MessageReplies", fields: [parentId], references: [id])
  replies   ChatMessage[] @relation("MessageReplies")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("chat_messages")
}

model MessageRead {
  id        String   @id @default(cuid())
  messageId String
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  readAt    DateTime @default(now())

  @@unique([messageId, userId])
  @@map("message_reads")
}

model Document {
  id          String        @id @default(cuid())
  title       String
  description String?
  type        DocumentType
  category    String?       // "Reglamento", "Acta", "Contrato", etc.
  fileUrl     String
  fileName    String
  fileSize    Int
  mimeType    String
  version     String        @default("1.0")
  isPublic    Boolean       @default(false)
  isArchived  Boolean       @default(false)
  
  // Relaciones
  propertyId  String?
  property    Property?     @relation(fields: [propertyId], references: [id])
  uploadedById String
  uploadedBy  User          @relation(fields: [uploadedById], references: [id])
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Control de acceso
  permissions DocumentPermission[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("documents")
}

model DocumentPermission {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  role       UserRole? // Si es null, aplica a todos los usuarios del tenant
  canView    Boolean  @default(true)
  canEdit    Boolean  @default(false)
  canDelete  Boolean  @default(false)

  @@unique([documentId, userId])
  @@map("document_permissions")
}

// ENUMS CORREGIDOS (sin duplicados)
enum UserRole {
  SUPER_ADMIN
  ADMIN
  MAINTENANCE
  RESIDENT
}

enum PlanType {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PAST_DUE
}

enum UnitType {
  APARTMENT
  OFFICE
  COMMERCIAL
  STORAGE
}

enum ExpenseType {
  ORDINARY
  EXTRAORDINARY
  FUND
  SPECIAL
}

enum ExpenseStatus {
  DRAFT
  OPEN
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  MERCADOPAGO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CANCELLED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum NotificationType {
  PAYMENT_OVERDUE
  PAYMENT_REMINDER
  MAINTENANCE_SCHEDULED
  MEETING_REMINDER
  TICKET_UPDATE
  EXPENSE_APPROVED
  GENERAL_ANNOUNCEMENT
}

enum CalendarEventType {
  MEETING
  MAINTENANCE
  PAYMENT_DUE
  INSPECTION
  HOLIDAY
  OTHER
}

enum AttendeeStatus {
  PENDING
  ACCEPTED
  DECLINED
  TENTATIVE
}

enum ChatRoomType {
  DIRECT
  GROUP
  PROPERTY
  MAINTENANCE
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum DocumentType {
  REGULATION
  MEETING_MINUTES
  CONTRACT
  FINANCIAL_STATEMENT
  MAINTENANCE_REPORT
  INSURANCE
  BUDGET
  OTHER
}